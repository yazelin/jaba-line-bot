# 統一配置：支援 jaba.ui 域名 + IP 分流

# 根據來源 IP 設定後端伺服器
geo $backend {
    default          192.168.11.9:8099;  # 外網 → 8099
    192.168.11.0/24  192.168.11.9:8098;  # 區網 → 8098
    192.168.11.1     192.168.11.9:8099;  # 路由器 NAT（外網流量）→ 8099
    192.168.100.0/24 192.168.11.9:8098;  # Docker → 8098
}

# 標記是否為內網 IP
geo $is_internal {
    default          0;  # 外網
    192.168.11.0/24  1;  # 區網
    192.168.11.1     0;  # 路由器 NAT（外網流量）→ 視為外網
    192.168.100.0/24 1;  # Docker
}

# 預設 server：處理不符合 jaba.ui 的請求
server {
    listen 80 default_server;
    server_name _;

    # LINE Bot jaba API（需要 API Key 驗證）
    location /jaba-api/ {
        # API Key 驗證
        if ($http_x_api_key != "this_is_my_jaba_api_key") {
            return 403;
        }

        # 代理到 jaba 服務（port 8098）
        proxy_pass http://192.168.11.9:8098/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 延長 timeout（AI 回應需要時間）
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    location / {
        # 內網但域名不對 → 403
        if ($is_internal) {
            return 403;
        }
        # 外網 → 代理到 8099
        proxy_pass http://192.168.11.9:8099;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# jaba.ui server：處理正確域名的請求
server {
    listen 80;
    server_name jaba.ui;

    # 允許較大的請求 body（支援菜單圖片上傳）
    client_max_body_size 20m;

    # Socket.IO WebSocket 專用路徑
    location /socket.io/ {
        proxy_pass http://$backend;
        proxy_http_version 1.1;

        # WebSocket 必要 headers
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 延長 timeout（WebSocket 長連線需要）
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location / {
        proxy_pass http://$backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 延長 timeout（影像辨識需要較長時間）
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
