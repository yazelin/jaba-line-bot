# 系統架構

## 整體架構圖

```
                                    ┌─────────────────────────────────────────────────────────────┐
                                    │                        網際網路                              │
                                    └─────────────────────────────────────────────────────────────┘
                                                              │
                    ┌─────────────────────────────────────────┼─────────────────────────────────────────┐
                    │                                         │                                         │
                    ▼                                         ▼                                         │
           ┌─────────────────┐                       ┌─────────────────┐                               │
           │  LINE Platform  │                       │     Render      │                               │
           │   (日本機房)     │                       │   (雲端平台)     │                               │
           │                 │   webhook POST        │                 │                               │
           │  - 訊息接收     │ ────────────────────> │  jaba-line-bot  │                               │
           │  - 訊息發送     │ <──────────────────── │   (Flask App)   │                               │
           │                 │   reply message       │                 │                               │
           └─────────────────┘                       └────────┬────────┘                               │
                    ▲                                         │                                         │
                    │                                         │ HTTPS + API Key                        │
                    │                                         ▼                                         │
           ┌─────────────────┐                       ┌─────────────────┐                               │
           │   LINE 使用者    │                       │  ching-tech.    │                               │
           │                 │                       │  ddns.net       │                               │
           │  - 個人聊天     │                       │   (DDNS)        │                               │
           │  - 群組聊天     │                       └────────┬────────┘                               │
           └─────────────────┘                                │                                         │
                                                              │ Port 80                                 │
                                    ┌─────────────────────────┼─────────────────────────────────────────┘
                                    │                         │
                                    │     ┌───────────────────┼───────────────────┐
                                    │     │    192.168.11.9   │    本地伺服器      │
                                    │     │                   ▼                   │
                                    │     │          ┌─────────────────┐          │
                                    │     │          │     nginx       │          │
                                    │     │          │  (API Gateway)  │          │
                                    │     │          │                 │          │
                                    │     │          │  /jaba-api/*    │          │
                                    │     │          │  API Key 驗證   │          │
                                    │     │          └────────┬────────┘          │
                                    │     │                   │                   │
                                    │     │                   │ proxy_pass        │
                                    │     │                   ▼                   │
                                    │     │          ┌─────────────────┐          │
                                    │     │          │   jaba 系統      │          │
                                    │     │          │   (FastAPI)     │          │
                                    │     │          │   Port 8098     │          │
                                    │     │          │                 │          │
                                    │     │          │  - AI 對話     │          │
                                    │     │          │  - 訂單管理    │          │
                                    │     │          │  - 白名單      │          │
                                    │     │          └─────────────────┘          │
                                    │     │                                       │
                                    │     └───────────────────────────────────────┘
                                    │                     區域網路
                                    └─────────────────────────────────────────────
```

## 元件說明

### 1. LINE Platform

LINE 官方的訊息平台，負責：
- 接收使用者發送的訊息
- 透過 Webhook 轉發訊息到我們的伺服器
- 接收我們的 API 呼叫，發送回覆訊息給使用者

### 2. Render (jaba-line-bot)

雲端部署的 Flask 應用程式，負責：
- 接收 LINE Platform 的 Webhook 請求
- 驗證 LINE 簽章（防止偽造請求）
- 判斷是否需要回應（群組中的觸發條件）
- 檢查白名單權限
- 轉發訊息到 jaba 系統
- 回覆 LINE 訊息

**為什麼用 Render？**
- LINE Webhook 需要公開的 HTTPS URL
- Render 免費方案提供 HTTPS
- 無需自行管理 SSL 憑證

### 3. nginx (API Gateway)

運行在本地伺服器上的反向代理，負責：
- 驗證 API Key（只允許授權的請求）
- 將 `/jaba-api/*` 路徑轉發到 jaba 系統
- 根據來源 IP 分流（內網/外網）

### 4. jaba 系統

核心的 AI 點餐系統，負責：
- AI 對話處理（理解使用者意圖）
- 訂單管理（新增、修改、查詢）
- 店家與菜單管理
- 白名單管理

## 資料流程

### 使用者發送訊息

```
1. 使用者在 LINE 發送 "我要一個雞腿便當"
   │
   ▼
2. LINE Platform 收到訊息，發送 Webhook POST 到 Render
   POST https://jaba-line-bot.onrender.com/callback
   Header: X-Line-Signature: <簽章>
   Body: { events: [{ type: "message", message: { text: "我要一個雞腿便當" }, ... }] }
   │
   ▼
3. jaba-line-bot 收到請求
   a. 驗證 X-Line-Signature（確認來自 LINE）
   b. 解析訊息內容
   c. 判斷是否需要回應（1對1 永遠回應，群組需觸發詞）
   d. 檢查白名單（呼叫 jaba API）
   │
   ▼
4. jaba-line-bot 轉發到 jaba 系統
   POST https://ching-tech.ddns.net/jaba-api/api/chat
   Header: X-API-Key: <API金鑰>
   Body: { username: "王小明", message: "我要一個雞腿便當", is_manager: false }
   │
   ▼
5. nginx 收到請求
   a. 驗證 X-API-Key
   b. 轉發到 jaba 系統（Port 8098）
   │
   ▼
6. jaba 系統處理
   a. AI 理解使用者意圖
   b. 執行點餐動作
   c. 回傳回應訊息
   │
   ▼
7. 回應一路傳回
   jaba → nginx → Render → LINE Platform → 使用者
```

### 使用者註冊（啟用）

```
1. 使用者發送啟用密碼 "XXXXXX"
   │
   ▼
2. jaba-line-bot 識別為啟用指令
   │
   ▼
3. 呼叫 jaba 註冊 API
   POST /jaba-api/api/linebot/register
   Body: { type: "user"|"group", id: "<LINE ID>", name: "<顯示名稱>" }
   │
   ▼
4. jaba 將 ID 加入白名單
   │
   ▼
5. 回覆使用者 "啟用成功"
```

## 安全機制

### 1. LINE 簽章驗證

LINE Platform 會在每個 Webhook 請求的 Header 加上 `X-Line-Signature`。jaba-line-bot 使用 Channel Secret 驗證此簽章，確保請求確實來自 LINE。

```python
# line-bot-sdk 自動處理驗證
handler.handle(body, signature)  # 簽章錯誤會拋出 InvalidSignatureError
```

### 2. API Key 驗證

Render 到 jaba 的請求需要攜帶 API Key，nginx 會驗證：

```nginx
if ($http_x_api_key != "your_api_key") {
    return 403;
}
```

### 3. 白名單機制

只有在白名單中的使用者/群組才能使用點餐功能：
- 個人聊天：檢查 user_id
- 群組聊天：檢查 group_id

### 4. 密碼啟用

啟用功能需要知道密碼，密碼透過環境變數設定，不會出現在程式碼中。

## 網路拓撲

```
┌──────────────────────────────────────────────────────────────────────────┐
│                              網際網路                                     │
│                                                                          │
│    ┌──────────────┐         ┌──────────────┐         ┌──────────────┐   │
│    │ LINE 使用者  │ <─────> │LINE Platform │ <─────> │   Render     │   │
│    └──────────────┘         └──────────────┘         └──────┬───────┘   │
│                                                             │           │
└─────────────────────────────────────────────────────────────┼───────────┘
                                                              │
                                                              │ HTTPS
                                                              ▼
                                                    ┌──────────────────┐
                                                    │ ching-tech.ddns  │
                                                    │   (DDNS 指向)     │
                                                    │  公網 IP:80      │
                                                    └────────┬─────────┘
                                                             │
                                                             │ NAT
                                                             ▼
┌────────────────────────────────────────────────────────────────────────┐
│                         192.168.11.0/24 區域網路                        │
│                                                                        │
│    ┌──────────────────────────────────────────────────────────────┐   │
│    │                     192.168.11.9 本地伺服器                    │   │
│    │                                                              │   │
│    │   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐ │   │
│    │   │   nginx     │ ───> │   jaba      │      │   其他服務   │ │   │
│    │   │   :80       │      │   :8098     │      │             │ │   │
│    │   └─────────────┘      └─────────────┘      └─────────────┘ │   │
│    │                                                              │   │
│    └──────────────────────────────────────────────────────────────┘   │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

## 相關文件

- [LINE 設定指南](line-setup.md)
- [部署指南](deployment.md)
- [jaba 整合說明](jaba-integration.md)
- [環境變數說明](configuration.md)
